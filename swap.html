<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CryptoSwap.live - Cosmetic Crypto Swap</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <h1>CryptoSwap.live</h1>
  <button id="wallet-btn">Connect Wallet</button>
</header>

<main>
  <section class="swap-container" aria-label="Swap form">
    <h2>Swap Tokens</h2>
    <form class="swap-form" id="swap-form" autocomplete="off" novalidate>
      <div>
        <label for="from-token">From</label>
        <select id="from-token" name="from-token" required>
          <option value="" disabled selected>Select token</option>
          <option value="BTC">Bitcoin (BTC)</option>
          <option value="ETH">Ethereum (ETH)</option>
          <option value="USDT">Tether (USDT)</option>
          <option value="BNB">Binance Coin (BNB)</option>
          <option value="ADA">Cardano (ADA)</option>
          <option value="SOL">Solana (SOL)</option>
          <option value="LTC">Litecoin (LTC)</option>
        </select>
      </div>

      <div>
        <label for="from-amount">Amount</label>
        <input type="number" id="from-amount" name="from-amount" min="0" step="any" placeholder="0.0" required />
      </div>

      <div>
        <label for="to-token">To</label>
        <select id="to-token" name="to-token" required>
          <option value="" disabled selected>Select token</option>
          <option value="BTC">Bitcoin (BTC)</option>
          <option value="ETH">Ethereum (ETH)</option>
          <option value="USDT">Tether (USDT)</option>
          <option value="BNB">Binance Coin (BNB)</option>
          <option value="ADA">Cardano (ADA)</option>
          <option value="SOL">Solana (SOL)</option>
          <option value="LTC">Litecoin (LTC)</option>
        </select>
      </div>

      <button type="submit" class="swap-btn" disabled>Swap</button>

      <div class="rate-display" id="rate-display">
        Select tokens and amount to see estimated rate
      </div>
    </form>
  </section>

  <section class="history-container" aria-label="Recent swap history">
    <h3>Recent Swaps</h3>
    <table>
      <thead>
        <tr>
          <th>Date & Time</th>
          <th>From</th>
          <th>Amount</th>
          <th>To</th>
          <th>Received</th>
        </tr>
      </thead>
      <tbody id="swap-history">
        <!-- Rows rendered by JS -->
      </tbody>
    </table>
  </section>
</main>

<!-- Wallet Modal -->
<div class="modal" id="wallet-modal" role="dialog" aria-modal="true">
  <div class="modal-content">
    <h4>Connected Wallet</h4>
    <div class="wallet-address" id="wallet-address">0x1234...ABCD5678EF90</div>
    <button class="modal-close-btn" id="wallet-close-btn">Close</button>
  </div>
</div>

<script>
(() => {
  const walletBtn = document.getElementById('wallet-btn');
  const walletModal = document.getElementById('wallet-modal');
  const walletCloseBtn = document.getElementById('wallet-close-btn');
  const walletAddressEl = document.getElementById('wallet-address');

  const fromTokenSelect = document.getElementById('from-token');
  const toTokenSelect = document.getElementById('to-token');
  const fromAmountInput = document.getElementById('from-amount');
  const swapBtn = document.querySelector('button.swap-btn');
  const rateDisplay = document.getElementById('rate-display');
  const historyTbody = document.getElementById('swap-history');

  const tokenIds = {
    BTC: 'bitcoin',
    ETH: 'ethereum',
    USDT: 'tether',
    BNB: 'binancecoin',
    ADA: 'cardano',
    SOL: 'solana',
    LTC: 'litecoin'
  };

  let usdPrices = {};
  let swapHistory = [];

  function formatDate(date) {
    const pad = n => n.toString().padStart(2, '0');
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
  }

  function renderHistory() {
    historyTbody.innerHTML = '';
    const last10 = swapHistory.slice(-10).reverse();
    for (const swap of last10) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDate(swap.date)}</td>
        <td>${swap.fromToken}</td>
        <td>${swap.amount.toFixed(6)}</td>
        <td>${swap.toToken}</td>
        <td>${swap.received.toFixed(6)}</td>
      `;
      historyTbody.appendChild(tr);
    }
  }

  function validateForm() {
    const fromToken = fromTokenSelect.value;
    const toToken = toTokenSelect.value;
    const amount = parseFloat(fromAmountInput.value);
    const valid = fromToken && toToken && fromToken !== toToken && amount > 0;
    swapBtn.disabled = !valid;
    if (!valid) rateDisplay.textContent = 'Select tokens and amount to see estimated rate';
    return valid;
  }

  async function fetchPrices() {
    const ids = Object.values(tokenIds).join(',');
    try {
      const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);
      const data = await res.json();
      usdPrices = {};
      for (const [symbol, id] of Object.entries(tokenIds)) {
        usdPrices[symbol] = data[id]?.usd || null;
      }
    } catch (e) {
      console.error('Failed to fetch prices:', e);
    }
  }

  function updateRate() {
    if (!validateForm()) return;
    const from = fromTokenSelect.value;
    const to = toTokenSelect.value;
    const amount = parseFloat(fromAmountInput.value);
    const fromPrice = usdPrices[from];
    const toPrice = usdPrices[to];
    if (fromPrice == null || toPrice == null) {
      rateDisplay.textContent = 'Live price unavailable.';
      return;
    }
    const rate = fromPrice / toPrice;
    const received = amount * rate;
    rateDisplay.textContent = `Estimated: ${received.toFixed(6)} ${to} (1 ${from} â‰ˆ ${rate.toFixed(6)} ${to})`;
  }

  function generateUUID() {
    if (crypto.randomUUID) return crypto.randomUUID();
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  function handleSwapSubmit(e) {
    e.preventDefault();
    if (!validateForm()) return;

    const from = fromTokenSelect.value;
    const to = toTokenSelect.value;
    const amount = parseFloat(fromAmountInput.value);
    const fromUSD = usdPrices[from];
    const toUSD = usdPrices[to];
    const rate = fromUSD / toUSD;
    const received = amount * rate;

    const swapId = generateUUID();
    const sendUSD = amount * fromUSD;
    const receiveUSD = sendUSD * 0.99;
    const fee = sendUSD * 0.01;

    const swapData = {
      id: swapId,
      fromToken: from,
      toToken: to,
      amount: parseFloat(amount.toFixed(8)),
      received: parseFloat(received.toFixed(8)),
      sendUSD: parseFloat(sendUSD.toFixed(2)),
      receiveUSD: parseFloat(receiveUSD.toFixed(2)),
      fee: parseFloat(fee.toFixed(2)),
      destination: '0x1234...ABCD5678EF90',
      date: new Date()
    };

    localStorage.setItem('latestSwap', JSON.stringify(swapData));
    window.location.href = `/swap/index.html?swapId=${swapId}`;
  }

  // Event listeners
  walletBtn.onclick = () => {
    walletAddressEl.textContent = '0x1234...ABCD5678EF90';
    walletModal.classList.add('active');
    walletBtn.textContent = 'Wallet Connected';
    walletBtn.disabled = true;
  };
  walletCloseBtn.onclick = () => walletModal.classList.remove('active');
  walletModal.onclick = e => { if (e.target === walletModal) walletModal.classList.remove('active'); };
  window.onkeydown = e => { if (e.key === 'Escape') walletModal.classList.remove('active'); };

  [fromTokenSelect, toTokenSelect, fromAmountInput].forEach(el => el.addEventListener('input', updateRate));
  document.getElementById('swap-form').addEventListener('submit', handleSwapSubmit);

  renderHistory();
  fetchPrices().then(updateRate);
  setInterval(fetchPrices, 60000);
})();
</script>
</body>
</html>
