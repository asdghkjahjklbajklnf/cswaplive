<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CryptoSwap.live - Cosmetic Crypto Swap</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <h1>CryptoSwap.live</h1>
  <button id="wallet-btn">Connect Wallet</button>
</header>

<main>
  <section class="swap-container" aria-label="Swap form">
    <h2>Swap Tokens</h2>
    <form class="swap-form" id="swap-form" autocomplete="off" novalidate>
      <div>
        <label for="from-token">From</label>
        <select id="from-token" name="from-token" required aria-required="true" aria-label="Select token to swap from">
          <option value="" disabled selected>Select token</option>
          <option value="BTC">Bitcoin (BTC)</option>
          <option value="ETH">Ethereum (ETH)</option>
          <option value="USDT">Tether (USDT)</option>
          <option value="BNB">Binance Coin (BNB)</option>
          <option value="ADA">Cardano (ADA)</option>
          <option value="SOL">Solana (SOL)</option>
          <option value="LTC">Litecoin (LTC)</option>
        </select>
      </div>

      <div>
        <label for="from-amount">Amount</label>
        <input type="number" id="from-amount" name="from-amount" min="0" step="any" placeholder="0.0" required aria-required="true" />
      </div>

      <div>
        <label for="to-token">To</label>
        <select id="to-token" name="to-token" required aria-required="true" aria-label="Select token to swap to">
          <option value="" disabled selected>Select token</option>
          <option value="BTC">Bitcoin (BTC)</option>
          <option value="ETH">Ethereum (ETH)</option>
          <option value="USDT">Tether (USDT)</option>
          <option value="BNB">Binance Coin (BNB)</option>
          <option value="ADA">Cardano (ADA)</option>
          <option value="SOL">Solana (SOL)</option>
          <option value="LTC">Litecoin (LTC)</option>
        </select>
      </div>

      <button type="submit" class="swap-btn" disabled>Swap</button>

      <div class="rate-display" aria-live="polite" aria-atomic="true" id="rate-display">
        Select tokens and amount to see estimated rate
      </div>
    </form>
  </section>

  <section class="history-container" aria-label="Recent swap history">
    <h3>Recent Swaps</h3>
    <table role="table" aria-describedby="history-description">
      <thead>
        <tr>
          <th scope="col">Date & Time</th>
          <th scope="col">From</th>
          <th scope="col">Amount</th>
          <th scope="col">To</th>
          <th scope="col">Received</th>
        </tr>
      </thead>
      <tbody id="swap-history">
        <!-- dummy rows inserted by JS -->
      </tbody>
    </table>
    <p id="history-description" class="sr-only">Table showing recent cosmetic token swaps with date, tokens, and amounts</p>
  </section>
</main>

<!-- Wallet Modal -->
<div class="modal" id="wallet-modal" role="dialog" aria-modal="true" aria-labelledby="wallet-modal-title" tabindex="-1">
  <div class="modal-content">
    <h4 id="wallet-modal-title">Connected Wallet</h4>
    <div class="wallet-address" id="wallet-address" tabindex="0" aria-label="Wallet address">
      0x1234...ABCD5678EF90
    </div>
    <button class="modal-close-btn" id="wallet-close-btn" aria-label="Close wallet modal">Close</button>
  </div>
</div>

<script>
  (() => {
    const walletBtn = document.getElementById('wallet-btn');
    const walletModal = document.getElementById('wallet-modal');
    const walletCloseBtn = document.getElementById('wallet-close-btn');
    const walletAddressEl = document.getElementById('wallet-address');

    const fromTokenSelect = document.getElementById('from-token');
    const toTokenSelect = document.getElementById('to-token');
    const fromAmountInput = document.getElementById('from-amount');
    const swapBtn = document.querySelector('button.swap-btn');
    const rateDisplay = document.getElementById('rate-display');
    const historyTbody = document.getElementById('swap-history');

    // Token IDs for CoinGecko API
    const tokenIds = {
      BTC: 'bitcoin',
      ETH: 'ethereum',
      USDT: 'tether',
      BNB: 'binancecoin',
      ADA: 'cardano',
      SOL: 'solana',
      LTC: 'litecoin'
    };

    // Store USD prices fetched from API
    let usdPrices = {};

    // Dummy swap history array (initial dummy data)
    let swapHistory = [
      {date: new Date(Date.now()-600000), fromToken:'ETH', toToken:'BTC', amount:1.2, received:0.082},
      {date: new Date(Date.now()-1200000), fromToken:'USDT', toToken:'ADA', amount:500, received:1750},
      {date: new Date(Date.now()-1800000), fromToken:'LTC', toToken:'ETH', amount:3, received:0.24},
      {date: new Date(Date.now()-2400000), fromToken:'BNB', toToken:'SOL', amount:7, received:8.05},
      {date: new Date(Date.now()-3000000), fromToken:'BTC', toToken:'USDT', amount:0.05, received:1350}
    ];

    // Format date/time as YYYY-MM-DD HH:mm:ss
    function formatDate(date) {
      const pad = n => n.toString().padStart(2, '0');
      return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ` +
             `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    }

    function renderHistory() {
      historyTbody.innerHTML = '';
      const last10 = swapHistory.slice(-10).reverse();
      for (const swap of last10) {
        const tr = document.createElement('tr');

        const tdDate = document.createElement('td');
        tdDate.textContent = formatDate(swap.date);
        tr.appendChild(tdDate);

        const tdFrom = document.createElement('td');
        tdFrom.textContent = swap.fromToken;
        tr.appendChild(tdFrom);

        const tdAmount = document.createElement('td');
        tdAmount.textContent = swap.amount.toFixed(6);
        tr.appendChild(tdAmount);

        const tdTo = document.createElement('td');
        tdTo.textContent = swap.toToken;
        tr.appendChild(tdTo);

        const tdReceived = document.createElement('td');
        tdReceived.textContent = swap.received.toFixed(6);
        tr.appendChild(tdReceived);

        historyTbody.appendChild(tr);
      }
    }

    function addToHistory(swap) {
      swapHistory.push(swap);
      renderHistory();
    }

    // Validate form inputs
    function validateForm() {
      const fromToken = fromTokenSelect.value;
      const toToken = toTokenSelect.value;
      const amount = parseFloat(fromAmountInput.value);

      const valid = fromToken && toToken && fromToken !== toToken && amount > 0;
      swapBtn.disabled = !valid;

      if (!valid) {
        rateDisplay.textContent = 'Select tokens and amount to see estimated rate';
        return false;
      }
      return true;
    }

    // Fetch live USD prices from CoinGecko API
    async function fetchPrices() {
      const ids = Object.values(tokenIds).join(',');
      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Network response not ok');
        const data = await res.json();
        usdPrices = {};
        for (const [symbol, id] of Object.entries(tokenIds)) {
          usdPrices[symbol] = data[id]?.usd || null;
        }
      } catch (e) {
        console.error('Error fetching prices:', e);
      }
    }

    // Update rate display with live data
    function updateRate() {
      if (!validateForm()) return;

      const fromToken = fromTokenSelect.value;
      const toToken = toTokenSelect.value;
      const amount = parseFloat(fromAmountInput.value);

      const fromPrice = usdPrices[fromToken];
      const toPrice = usdPrices[toToken];

      if (fromPrice == null || toPrice == null) {
        rateDisplay.textContent = 'Live price data unavailable. Please try again later.';
        return;
      }

      const rate = fromPrice / toPrice;
      const received = amount * rate;

      rateDisplay.textContent = `Estimated: ${received.toFixed(6)} ${toToken} (Rate: 1 ${fromToken} â‰ˆ ${rate.toFixed(6)} ${toToken})`;
    }

    // Handle swap submit (cosmetic)
    function handleSwapSubmit(e) {
      e.preventDefault();

      if (!validateForm()) return;

      const fromToken = fromTokenSelect.value;
      const toToken = toTokenSelect.value;
      const amount = parseFloat(fromAmountInput.value);

      const fromPrice = usdPrices[fromToken];
      const toPrice = usdPrices[toToken];
      if (fromPrice == null || toPrice == null) {
        alert('Price data unavailable. Please try again.');
        return;
      }

      const rate = fromPrice / toPrice;
      const received = amount * rate;

      addToHistory({
        date: new Date(),
        fromToken,
        toToken,
        amount,
        received
      });

      fromTokenSelect.value = "";
      toTokenSelect.value = "";
      fromAmountInput.value = "";
      swapBtn.disabled = true;
      rateDisplay.textContent = 'Select tokens and amount to see estimated rate';
    }

    // Wallet modal logic (cosmetic)
    let walletConnected = false;
    const fakeWalletAddress = '0x1234...ABCD5678EF90';

    walletBtn.addEventListener('click', () => {
      if (!walletConnected) {
        walletAddressEl.textContent = fakeWalletAddress;
        walletModal.classList.add('active');
        walletConnected = true;
        walletBtn.textContent = 'Wallet Connected';
        walletBtn.disabled = true;
      }
    });

    walletCloseBtn.addEventListener('click', () => {
      walletModal.classList.remove('active');
    });

    walletModal.addEventListener('click', e => {
      if (e.target === walletModal) walletModal.classList.remove('active');
    });

    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && walletModal.classList.contains('active')) {
        walletModal.classList.remove('active');
      }
    });

    // Input events
    [fromTokenSelect, toTokenSelect, fromAmountInput].forEach(el => {
      el.addEventListener('input', () => {
        updateRate();
      });
    });

    // Form submit event
    document.getElementById('swap-form').addEventListener('submit', handleSwapSubmit);

    // Initial render
    renderHistory();

    // Fetch prices once on load, then every 60s
    async function refreshPrices() {
      await fetchPrices();
      updateRate();
    }
    refreshPrices();
    setInterval(refreshPrices, 60000);
  })();
</script>

</body>
</html>
