<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>swapnow.lol - Crypto Exchange</title>
  <link rel="icon" type="image/png" sizes="512x512" href="https://i.imgur.com/is9ctnz.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    :root {
      --bg-dark: #0b0b10;
      --bg-darker: #0a0a0f;
      --card: rgba(18, 18, 26, 0.7);
      --card-solid: #13131a;
      --accent: #9b59ff;
      --accent-2: #6d43ff;
      --accent-hover: #7b4bff;
      --text-light: #e7e7f1;
      --text-muted: #a8a8c7;
      --input-bg: #15151d;
      --input-border: #2a2750;
      --swap-btn-bg: linear-gradient(135deg, #9b59ff, #6d43ff);
      --swap-btn-bg-hover: linear-gradient(135deg, #b07aff, #8261ff);
      --ring: 0 0 0 4px rgba(155, 89, 255, 0.15);
      --shadow-lg: 0 20px 50px rgba(0, 0, 0, 0.6);
      --shadow-sm: 0 4px 16px rgba(0, 0, 0, 0.35);
      --border: 1px solid rgba(255, 255, 255, 0.06);
      --glass: blur(10px) saturate(120%);
      --error-bg: #2b0f18;
      --error-text: #ffb6c1;
      --success: #37d67a;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #1a1340 0%, transparent 60%),
                  radial-gradient(1000px 700px at 110% 20%, #0e3c5a 0%, transparent 60%),
                  radial-gradient(1200px 900px at 50% 120%, #2a1258 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg-darker), var(--bg-dark));
      color: var(--text-light);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
    }

    .bg-sheen { position: fixed; inset: 0; pointer-events: none;
      background: conic-gradient(from 200deg at 70% 20%, rgba(155,89,255,0.12), rgba(109,67,255,0.08), transparent 40%);
      mix-blend-mode: screen; animation: drift 18s linear infinite; opacity: 0.9; }
    @keyframes drift { 0%{transform:translateY(0) rotate(0)} 50%{transform:translateY(-2%) rotate(1deg)} 100%{transform:translateY(0) rotate(0)} }

    header { max-width: 1200px; margin: 0 auto; padding: 24px 24px 12px; display: flex; align-items: center; justify-content: space-between; }
    .brand { display:flex; align-items:center; gap:12px; text-decoration:none; color:var(--text-light); }
    .logo { width:36px; height:36px; border-radius:12px;
      background: radial-gradient(120% 120% at 20% 20%, #b88cff 0%, #6d43ff 50%, #3e1a7a 100%);
      box-shadow: 0 8px 24px rgba(109,67,255,0.35), inset 0 0 12px rgba(255,255,255,0.12); }
    .brand h1 { font-size:1.15rem; margin:0; letter-spacing:.4px; }
    .tag { color:var(--text-muted); font-size:.85rem; }

    main { max-width: 1200px; margin: 0 auto; padding: 12px 24px 48px; display: grid; grid-template-columns: 3fr 1.2fr; gap: 24px; min-height: 75vh; }
    .left-main { display:flex; flex-direction:column; gap:24px; }

    .card { background:var(--card); backdrop-filter:var(--glass); -webkit-backdrop-filter:var(--glass);
      border-radius:16px; box-shadow:var(--shadow-lg); border:var(--border); }

    .swap-container { padding:28px; display:flex; flex-direction:column; gap:18px; }
    .swap-container h2 { margin:0 0 8px 0; font-weight:700; font-size:1.75rem; color:#d9ccff; letter-spacing:.3px; }

    form.swap-form { display:flex; flex-direction:column; gap:16px; }
    label { font-weight:600; margin-bottom:6px; color:var(--text-muted); user-select:none; }
    .field { display:grid; grid-template-columns:1fr; }

    select, input[type="number"], input[type="text"]{
      width:100%; background:var(--input-bg); border:1px solid var(--input-border); border-radius:12px;
      padding:14px 16px; color:var(--text-light); font-size:1.05rem; font-weight:600;
      transition:border-color .25s ease, box-shadow .25s ease, transform .06s ease;
      font-family:'Poppins',sans-serif; letter-spacing:.02em; user-select:text;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
    }
    select:focus, input[type="number"]:focus, input[type="text"]:focus{ outline:none; border-color:var(--accent); box-shadow:var(--ring);}
    select:hover, input[type="number"]:hover, input[type="text"]:hover{ border-color:#3a2a7a;}
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{ opacity:.3; }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .amount-toggle{
      display:inline-flex; gap:10px; align-items:center; flex-wrap:wrap; font-weight:600; color:#cbbdff; user-select:none;
      background:rgba(109,67,255,0.08); padding:10px 12px; border-radius:999px; border:1px solid rgba(109,67,255,0.2);
      width:fit-content;
    }
    .amount-toggle label{ cursor:pointer; padding:6px 10px; border-radius:999px; }
    .amount-toggle input[type="radio"]{ margin-right:6px; accent-color:var(--accent); vertical-align:middle; }
    .amount-toggle label:hover{ background:rgba(109,67,255,0.15); }

    .inline{ display:grid; grid-template-columns:1fr; gap:8px; }
    .swap-actions{ display:grid; align-items:center; gap:8px; }

    button.swap-btn{
      margin-top:6px; padding:16px 18px; background:var(--swap-btn-bg); border:0; color:#fff; font-weight:800; font-size:1.05rem;
      border-radius:14px; cursor:pointer; box-shadow:0 10px 30px rgba(109,67,255,0.45);
      transition: transform .06s ease, box-shadow .25s ease, filter .25s ease; letter-spacing:.04em;
    }
    button.swap-btn:hover:not(:disabled){ filter:saturate(110%); box-shadow:0 16px 40px rgba(109,67,255,0.55);}
    button.swap-btn:active:not(:disabled){ transform:translateY(1px);}
    button.swap-btn:disabled{ background:linear-gradient(135deg,#4a3b77,#3a2f66); cursor:not-allowed; box-shadow:none; opacity:.8;}

    .rate-display{ margin-top:6px; font-weight:700; font-size:.98rem; color:var(--text-muted); min-height:1.4rem; letter-spacing:.02em; }

    .history-container{ padding:18px; }
    .history-container h3{ margin:0 0 12px 2px; font-weight:700; font-size:1.25rem; color:#d9ccff; }
    .table-wrap{ overflow:auto; border-radius:12px; border:var(--border); background:#0f0f16; }
    table{ width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums; min-width:640px; }
    thead th{
      position:sticky; top:0; z-index:1; background:linear-gradient(180deg, rgba(155,89,255,0.12), rgba(155,89,255,0.06));
      color:#d9ccff; padding:12px 14px; text-align:left; font-weight:700; border-bottom:1px solid rgba(255,255,255,0.06);
    }
    tbody tr{ border-bottom:1px solid rgba(255,255,255,0.06); transition:background-color .2s ease; }
    tbody tr:hover{ background:rgba(109,67,255,0.08); }
    tbody td{ color:var(--text-light); padding:12px 14px; font-weight:500; }

    .right-side{ padding:18px; }
    .tabs{ display:flex; flex-direction:column; gap:8px;}
    .tab-btn{ background:rgba(109,67,255,0.08); border:1px solid rgba(109,67,255,0.22); color:#e9e6ff;
      font-weight:800; font-size:1rem; cursor:pointer; text-align:left; padding:10px 12px; border-radius:12px;
      transition: background-color .25s, transform .06s, box-shadow .25s; user-select:none; width:100%;
    }
    .tab-btn:hover{ background:rgba(109,67,255,0.18); box-shadow:0 8px 22px rgba(109,67,255,0.25);}
    .tab-btn.active{ background:linear-gradient(135deg, rgba(155,89,255,0.28), rgba(109,67,255,0.22)); box-shadow:0 8px 26px rgba(109,67,255,0.35);}
    .tab-content{ background:linear-gradient(180deg, rgba(20,20,32,0.9), rgba(16,16,26,0.9)); border:var(--border); border-radius:14px;
      padding:14px; color:var(--text-light); font-weight:400; font-size:.98rem; line-height:1.5; display:none; user-select:text; min-height:110px;
    }
    .tab-content.active{ display:block; }

    .error-message{
      background:var(--error-bg); color:var(--error-text); border-radius:12px; padding:12px 14px; margin-top:8px; font-weight:700;
      display:flex; justify-content:space-between; align-items:center; border:1px solid rgba(255,70,70,.25); box-shadow:0 10px 30px rgba(255,70,70,.1);
    }
    .error-message button.close-error{ background:transparent; border:none; color:var(--error-text); font-weight:900; font-size:1.2rem; cursor:pointer; line-height:1; padding:0 6px; }

    .right-side.card, .history-container.card, .swap-container.card{ background:var(--card); }

    footer{ max-width:1200px; margin:0 auto; padding:24px; color:var(--text-muted); font-size:.9rem; }

    @media (max-width:1024px){ main{ grid-template-columns:1fr; } .right-side{ order:-1; } }
    @media (max-width:640px){
      header{ padding:18px 16px 8px; } main{ padding:8px 16px 32px; }
      .row{ grid-template-columns:1fr; } .swap-container{ padding:20px; } .history-container{ padding:14px; } .right-side{ padding:14px; }
      .brand h1{ font-size:1rem; }
    }
    @media (prefers-reduced-motion:reduce){ .bg-sheen{ animation:none; } button,select,input{ transition:none !important; } }
  </style>
</head>
<body>
  <div class="bg-sheen" aria-hidden="true"></div>

  <header>
    <a href="#" class="brand" aria-label="SwapNow Home">
      <span class="logo" aria-hidden="true"></span>
      <div>
        <h1>SwapNow.lol</h1>
        <div class="tag">Anonymous, non-custodial swaps</div>
      </div>
    </a>
  </header>

  <main>
    <section class="left-main">
      <section class="swap-container card" aria-label="Swap form">
        <h2>Swap Tokens</h2>
        <form class="swap-form" id="swap-form" autocomplete="off" novalidate>
          <div class="row">
            <div class="field">
              <label for="from-token">From</label>
              <select id="from-token" name="from-token" required aria-required="true" aria-label="Select token to swap from">
                <option value="" disabled selected>Select token</option>
                <option value="BTC">Bitcoin (BTC)</option>
                <option value="ETH">Ethereum (ETH)</option>
                <option value="USDT">Tether (USDT)</option>
                <option value="BNB">Binance Coin (BNB)</option>
                <option value="ADA">Cardano (ADA)</option>
                <option value="SOL">Solana (SOL)</option>
                <option value="LTC">Litecoin (LTC)</option>
              </select>
            </div>
            <div class="field">
              <label for="to-token">To</label>
              <select id="to-token" name="to-token" required aria-required="true" aria-label="Select token to swap to">
                <option value="" disabled selected>Select token</option>
                <option value="BTC">Bitcoin (BTC)</option>
                <option value="ETH">Ethereum (ETH)</option>
                <option value="USDT">Tether (USDT)</option>
                <option value="BNB">Binance Coin (BNB)</option>
                <option value="ADA">Cardano (ADA)</option>
                <option value="SOL">Solana (SOL)</option>
                <option value="LTC">Litecoin (LTC)</option>
              </select>
            </div>
          </div>

          <div class="amount-toggle" role="radiogroup" aria-label="Choose input type for amount">
            <label><input type="radio" name="amount-type" value="crypto" checked> Crypto Amount</label>
            <label><input type="radio" name="amount-type" value="usd"> USD Amount</label>
          </div>

          <div class="inline">
            <label for="from-amount" id="amount-label">Amount (Crypto)</label>
            <input type="number" id="from-amount" name="from-amount" min="0" step="any" placeholder="0.00" required aria-required="true" />
          </div>

          <div class="inline">
            <label for="dest-address">Destination Address</label>
            <input type="text" id="dest-address" name="dest-address" placeholder="Enter destination wallet address" autocomplete="off" required />
          </div>

          <div class="swap-actions">
            <button type="submit" class="swap-btn" disabled>Swap</button>
            <div class="rate-display" aria-live="polite" aria-atomic="true" id="rate-display">Select tokens and amount to see estimated rate</div>
            <div id="error-container"></div>
          </div>
        </form>
      </section>

      <section class="history-container card" aria-label="Recent swap history">
        <h3>Recent Swaps</h3>
        <div class="table-wrap">
          <table role="table" aria-describedby="history-description">
            <thead>
              <tr>
                <th scope="col">Date & Time (PT)</th>
                <th scope="col">From</th>
                <th scope="col">Amount</th>
                <th scope="col">To</th>
                <th scope="col">Received</th>
              </tr>
            </thead>
            <tbody id="swap-history"><!-- rows inserted by JS --></tbody>
          </table>
        </div>
        <p id="history-description" class="sr-only">Recent Swaps</p>
      </section>
    </section>
  </main>

<script>
  (() => {
    // ---------- CoinGecko pricing ----------
    const CG_IDS = {
      BTC: 'bitcoin',
      ETH: 'ethereum',
      USDT: 'tether',
      BNB: 'binancecoin',
      ADA: 'cardano',
      SOL: 'solana',
      LTC: 'litecoin'
    };

    const usdPrices = {};
    const DEFAULT_PRICES = { BTC: 64000, ETH: 3000, USDT: 1, BNB: 500, ADA: 0.8, SOL: 150, LTC: 80 };
    const PRICE_CACHE_KEY = 'usd_prices_coingecko_v1';

    function applyPrices(map) {
      for (const k of Object.keys(CG_IDS)) {
        const v = map[k];
        usdPrices[k] = (typeof v === 'number' && isFinite(v) && v > 0) ? v : DEFAULT_PRICES[k];
      }
      if (!usdPrices.USDT || !isFinite(usdPrices.USDT)) usdPrices.USDT = 1;
    }

    async function fetchPrices() {
      try {
        const ids = Object.values(CG_IDS).join(',');
        const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`;
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('coingecko status ' + res.status);
        const data = await res.json();
        const fresh = {};
        for (const [sym, id] of Object.entries(CG_IDS)) {
          const val = data?.[id]?.usd;
          if (typeof val === 'number') fresh[sym] = val;
        }
        applyPrices(fresh);
        localStorage.setItem(PRICE_CACHE_KEY, JSON.stringify({ t: Date.now(), prices: fresh }));
      } catch (e) {
        const cached = localStorage.getItem(PRICE_CACHE_KEY);
        if (cached) {
          try {
            const { prices } = JSON.parse(cached);
            applyPrices(prices || DEFAULT_PRICES);
          } catch { applyPrices(DEFAULT_PRICES); }
        } else {
          applyPrices(DEFAULT_PRICES);
        }
      }
    }

    // ---------- History (localStorage) ----------
    const STORAGE_KEY = 'recent_swaps_v2';
    const MAX_ROWS = 10;       // cap
    const INITIAL_ROWS = 10;   // seed exactly 10
    let swapHistory = [];

    // spacing range: 2:08 to 20:44 (in seconds)
    const MIN_GAP_SEC = 128;
    const MAX_GAP_SEC = 1244;

    function saveHistory() {
      const plain = swapHistory.map(s => ({ ...s, date: s.date.toISOString() }));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(plain));
    }
    function loadHistory() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return false;
        const now = Date.now();
        swapHistory = arr
          .map(s => ({ ...s, date: new Date(s.date) }))
          .filter(s => s.date.getTime() <= now)
          .sort((a,b) => a.date - b.date)
          .slice(-MAX_ROWS);
        return true;
      } catch { return false; }
    }

    // ---------- Pacific Time formatter (always PT) ----------
    const PT_FORMATTER = new Intl.DateTimeFormat('en-US', {
      timeZone: 'America/Los_Angeles',
      year: 'numeric',
      month: 'short',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true,
      timeZoneName: 'short' // PDT/PST as appropriate
    });
    function formatDatePT(date) { return PT_FORMATTER.format(date); }

    // ---------- DOM ----------
    const fromTokenSelect = document.getElementById('from-token');
    const toTokenSelect   = document.getElementById('to-token');
    const fromAmountInput = document.getElementById('from-amount');
    const rateDisplay     = document.getElementById('rate-display');
    const swapBtn         = document.querySelector('.swap-btn');
    const historyTbody    = document.getElementById('swap-history');
    const amountToggleRadios = document.querySelectorAll('input[name="amount-type"]');
    const amountLabel     = document.getElementById('amount-label');
    const errorContainer  = document.getElementById('error-container');
    const destAddressInput= document.getElementById('dest-address');

    let currentAmountType = 'crypto';

    // ---------- Helpers ----------
    function randomInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function renderHistory() {
      historyTbody.innerHTML = '';
      for (const swap of swapHistory.slice().reverse()) {
        const tr = document.createElement('tr');
        const tdDate = document.createElement('td'); tdDate.textContent = formatDatePT(swap.date); tr.appendChild(tdDate);
        const tdFrom = document.createElement('td'); tdFrom.textContent = swap.fromToken; tr.appendChild(tdFrom);
        const tdAmount = document.createElement('td'); tdAmount.textContent = swap.amount.toFixed(5); tr.appendChild(tdAmount);
        const tdTo = document.createElement('td'); tdTo.textContent = swap.toToken; tr.appendChild(tdTo);
        const tdReceived = document.createElement('td'); tdReceived.textContent = swap.received.toFixed(5); tr.appendChild(tdReceived);
        historyTbody.appendChild(tr);
      }
    }

    // Add a new dummy swap with timestamp = NOW; keep list at MAX_ROWS by removing oldest.
    function addNewDummySwapNow() {
      const tokens = Object.keys(CG_IDS);
      const fromToken = tokens[randomInt(0, tokens.length - 1)];
      let toToken; do { toToken = tokens[randomInt(0, tokens.length - 1)]; } while (toToken === fromToken);

      // USD-bounded generator ($12–$857)
      const usdValue = Math.random() * (857 - 12) + 12;

      const fromPrice = usdPrices[fromToken] || DEFAULT_PRICES[fromToken];
      const toPrice   = usdPrices[toToken]   || DEFAULT_PRICES[toToken];

      const amount   = +(usdValue / fromPrice).toFixed(5); // from token amount
      const received = +(usdValue / toPrice).toFixed(5);   // to token amount

      const newSwap = { date: new Date(), fromToken, toToken, amount, received };

      if (swapHistory.length >= MAX_ROWS) swapHistory.shift(); // remove oldest
      swapHistory.push(newSwap); // add newest

      renderHistory();
      saveHistory();
    }

    // Seed exactly INITIAL_ROWS entries ending at NOW
    function seedInitialHistory() {
      const tokens = Object.keys(CG_IDS);
      const now = Date.now();
      let t = now;

      const seeded = [];

      // Create INITIAL_ROWS - 1 in the past with your gap range
      for (let i = 0; i < INITIAL_ROWS - 1; i++) {
        const gapSec = randomInt(MIN_GAP_SEC, MAX_GAP_SEC);
        t -= gapSec * 1000;

        const fromToken = tokens[randomInt(0, tokens.length - 1)];
        let toToken; do { toToken = tokens[randomInt(0, tokens.length - 1)]; } while (toToken === fromToken);

        const usdValue = Math.random() * (857 - 12) + 12;
        const fromPrice = usdPrices[fromToken] || DEFAULT_PRICES[fromToken];
        const toPrice   = usdPrices[toToken]   || DEFAULT_PRICES[toToken];

        const amount   = +(usdValue / fromPrice).toFixed(5);
        const received = +(usdValue / toPrice).toFixed(5);

        seeded.push({ date: new Date(t), fromToken, toToken, amount, received });
      }

      // Sort ascending, clamp to not-in-future
      const safeNow = Date.now();
      swapHistory = seeded
        .filter(s => s.date.getTime() <= safeNow)
        .sort((a,b) => a.date - b.date);

      // Add the final 10th row at NOW
      addNewDummySwapNow();

      // Ensure exactly 10 and render
      swapHistory = swapHistory.slice(-MAX_ROWS);
      renderHistory();
      saveHistory();
    }

    function calculateReceived(from, to, amount, amountType) {
      if (!from || !to || !amount || amount <= 0 || from === to) return null;
      const fromPrice = usdPrices[from] || DEFAULT_PRICES[from];
      const toPrice   = usdPrices[to]   || DEFAULT_PRICES[to];
      if (amountType === 'crypto') return amount * fromPrice / toPrice;
      return amount / toPrice; // USD input
    }

    function updateUI() {
      const from = fromTokenSelect.value;
      const to   = toTokenSelect.value;
      let amountVal = parseFloat(fromAmountInput.value);

      if (isNaN(amountVal) || amountVal <= 0) { swapBtn.disabled = true; rateDisplay.textContent = 'Enter a valid amount'; clearError(); return; }
      if (!from || !to || from === to) { swapBtn.disabled = true; rateDisplay.textContent = 'Select different tokens'; clearError(); return; }

      const fromPrice = usdPrices[from] || DEFAULT_PRICES[from];
      let usdValue = currentAmountType === 'crypto' ? amountVal * fromPrice : amountVal;

      if (usdValue < 10) { swapBtn.disabled = true; rateDisplay.textContent = 'Minimum swap amount is $10 USD equivalent'; clearError(); return; }
      swapBtn.disabled = false;

      clearError();
      const received = calculateReceived(from, to, amountVal, currentAmountType);
      if (received === null) { rateDisplay.textContent = 'Select valid tokens and amount'; return; }

      if (currentAmountType === 'crypto') {
        rateDisplay.textContent = `Estimated: ${received.toFixed(5)} ${to} (includes 1% fee)`;
      } else {
        const cryptoAmount = amountVal / fromPrice;
        rateDisplay.textContent = `Estimated: ${received.toFixed(5)} ${to} for $${amountVal.toFixed(2)} (≈ ${cryptoAmount.toFixed(5)} ${from}) (includes 1% fee)`;
      }
    }

    function showError(msg) {
      errorContainer.innerHTML = `
        <div class="error-message" role="alert" aria-live="assertive">
          ${msg}
          <button class="close-error" aria-label="Close error message">&times;</button>
        </div>
      `;
      const closeBtn = errorContainer.querySelector('.close-error');
      closeBtn.addEventListener('click', () => { clearError(); });
    }
    function clearError() { errorContainer.innerHTML = ''; }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random()*16|0, v = c === 'x' ? r : (r&0x3|0x8);
        return v.toString(16);
      });
    }

    function handleSwap(e) {
      e.preventDefault();
      if (swapBtn.disabled) {
        if (rateDisplay.textContent.includes('Minimum swap amount')) {
          showError('Minimum swap amount is $10 USD equivalent. Please increase the amount.');
        }
        return;
      }
      const from = fromTokenSelect.value;
      const to   = toTokenSelect.value;
      let amountVal = parseFloat(fromAmountInput.value);
      if (isNaN(amountVal) || amountVal <= 0 || !from || !to || from === to) return;

      const fromPrice = usdPrices[from] || DEFAULT_PRICES[from];
      let amountCrypto = currentAmountType === 'crypto' ? amountVal : (amountVal / fromPrice);

      const swapId = generateUUID();
      const toPrice   = usdPrices[to]   || DEFAULT_PRICES[to];
      const amountUsd = amountCrypto * fromPrice;
      const receivedBeforeFee = amountCrypto * fromPrice / toPrice;
      const fee = receivedBeforeFee * 0.01;
      const receivedAfterFee = receivedBeforeFee - fee;

      const swapData = {
        id: swapId,
        fromToken: from,
        toToken: to,
        amountCrypto: amountCrypto,
        amountUsd: amountUsd,
        receivedAmount: receivedAfterFee,
        receivedUsd: receivedAfterFee * toPrice,
        fee: fee,
        feeUsd: fee * toPrice,
        destAddress: destAddressInput.value,
        timestamp: Date.now()
      };
      localStorage.setItem(`swap_${swapId}`, JSON.stringify(swapData));
      window.location.href = `swap.html?id=${swapId}`;
    }

    // Optional tabs (safe if none present)
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    function activateTab(index) {
      tabButtons.forEach((btn, i) => {
        const selected = i === index;
        btn.classList.toggle('active', selected);
        btn.setAttribute('aria-selected', selected);
        btn.tabIndex = selected ? 0 : -1;
        if (tabContents[i]) { tabContents[i].classList.toggle('active', selected); tabContents[i].hidden = !selected; }
      });
    }
    tabButtons.forEach((btn, i) => {
      btn.addEventListener('click', () => activateTab(i));
      btn.addEventListener('keydown', e => {
        if (e.key === 'ArrowDown') { e.preventDefault(); const nextIndex = (i + 1) % tabButtons.length; tabButtons[nextIndex].focus(); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); const prevIndex = (i - 1 + tabButtons.length) % tabButtons.length; tabButtons[prevIndex].focus(); }
      });
    });

    // ---- Live scheduler: random delay each time in your range ----
    function scheduleNextSwap() {
      const gapSec = randomInt(MIN_GAP_SEC, MAX_GAP_SEC);
      setTimeout(() => {
        addNewDummySwapNow();
        scheduleNextSwap(); // schedule again with a new random gap
      }, gapSec * 1000);
    }

    // Init
    async function init() {
      await fetchPrices();
      const restored = loadHistory();

      if (!restored || swapHistory.length === 0) {
        seedInitialHistory(); // seeds exactly 10 rows (9 past spaced by your range + 1 at now)
      } else {
        renderHistory();
      }

      // Start randomized live updates using your gap range
      scheduleNextSwap();

      // Refresh prices every minute
      setInterval(fetchPrices, 60000);
    }
    init();
  })();
</script>
</body>
</html>
